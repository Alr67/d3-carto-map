<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>d3.carto.map - Carto Layers 2</title>
  <meta charset="utf-8" />
    <link type="text/css" rel="stylesheet" href="../d3map.css" />
    <link type="text/css" rel="stylesheet" href="example.css" />
</head>
<script src="./bower_components/d3/d3.js" type="text/javascript">
</script>
<script src="./bower_components/topojson/topojson.js" type="text/javascript">
</script>
<script src="./resources/d3.geo.projection.min.js" type="text/javascript">
</script>
<script src="./bower_components/d3-plugins/geo/tile/tile.js" type="text/javascript">
</script>
<script src="./bower_components/colorbrewer/colorbrewer.js" type="text/javascript">
</script>
<script src="../d3.carto.map.js" type="text/javascript">
</script>
<style>
  html,body {
    height: 100%;
    width: 100%;
    margin: 0;
  }

  #map {
    height: 90%;
    width: 90%;
    top: 10%;
    position: absolute;
  }
  
  #title {
    padding: 20px;
  }
  
  .bluesquare {
    fill: steelblue;
    stroke: gray;
    stroke-width: 1px;
  }

  button.marker {
    position: fixed;
    z-index: 1;
    bottom: 150px;
    left: 150px;
  }
    .countryInfobox {
    color: pink;
    font-style: italic;
    padding: 20px;
  }
  </style>
<script>
  function makeSomeMaps() {
    map = d3.carto.map();

    d3.select("#map").call(map);

    tileLayer = d3.carto.layer.tile();
    tileLayer
    .path("examples.map-zgrqqx0w")
    .label("Base")
    .on("load", recenter);

    geojsonLayer = d3.carto.layer.geojson();
    geojsonLayer
    .path("./sampledata/world.geojson")
    .label("GeoBorders")
    .cssClass("countryborders")
    .renderMode("canvas")
    .on("load", createFeatureLayer);
    
    topojsonLayer = d3.carto.layer.topojson();
    topojsonLayer
    .path("./sampledata/sample_routes.topojson")
    .label("TopoRoutes")
    .cssClass("roads")
    .renderMode("svg")
    .clickableFeatures(true)
    .on("load", function() {console.log("load topojson")});

    csvModal = d3.carto.modal();
    csvModal.formatter(
      function(d) {return "<h1>" + d.properties.label + " in modern day " + d.properties.modern + "</h1>"}
    )
    
    csvLayer = d3.carto.layer.csv();
    csvLayer
    .type("csv")
    .path("./sampledata/sample_points.csv")
    .label("CSV Points")
    .cssClass("pinkcircle")
    .renderMode("svg")
    .markerSize(3)
    .x("x")
    .y("y")
    .modal(csvModal)
    .clickableFeatures(true)
    .on("load", changeMarkers);

    map.addCartoLayer(tileLayer);
    map.addCartoLayer(topojsonLayer);
    map.addCartoLayer(geojsonLayer);
    map.addCartoLayer(csvLayer);

    function recenter() {
      map.centerOn([3,43],"latlong");
    }

    function changeMarkers() {
      csvLayer.g().selectAll("g.pinkcircle").select("circle").remove();
      csvLayer.g().selectAll("g.pinkcircle").datum(function(d) {return {"properties": d}}).append("rect").attr("class", "bluesquare").attr("height", 5).attr("width",5).attr("x",-2.5).attr("y",-2.5)
//    To get the graphical elements to scale you need to do this
      map.refresh();
    }
    
    function createFeatureLayer() {
      var featuresArray = [];
      var mapLayers = map.layers();
      mapLayers.forEach(function (layer) {
        if (layer.label() == "GeoBorders") {
          featuresArray = layer.features();
        }
      })
     shortNameCountries = featuresArray.filter(function(d) {return d.properties.name.length < 7})

    featureModal = d3.carto.modal();
    featureModal.formatter(
      function(d) {return "<p class='countryInfobox'>The country of " + d.properties.name + " has a short name</p>"}
    )
    
    console.log(shortNameCountries)
    featureLayer = d3.carto.layer.featureArray();
    featureLayer
    .features(shortNameCountries)
    .label("Feature Array")
    .cssClass("halffilledcountries")
    .renderMode("svg")
    .clickableFeatures(true)
    .modal(featureModal)
    .on("load", function(){console.log("load featurearray")}); 
    
    map.addCartoLayer(featureLayer);

    }

  }
</script>
<body onload="makeSomeMaps()">
<div id="title">Using d3.carto.layer with <span style="font-weight:900">map.refresh</span> with <a href="https://github.com/emeeks/d3-carto-map">d3.carto.map</a>.</div>
<div id="map"></div>
<div id="infoBox"><p>Layers made with d3.carto.layer can be defined and then added to the map and will signal their having been added with a "load" event. The layers can also be accessed with map.layers().</p><p>Here layers are loaded using the d3.carto.layer.layerType() alias.</p></div>
</body>
</html>